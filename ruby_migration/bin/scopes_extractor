#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require_relative '../lib/scopes_extractor'
require 'thor'

module ScopesExtractor
  class CLI < Thor
    desc 'sync', 'Run a one-time synchronization'
    method_option :platform, aliases: '-p', desc: 'Sync a specific platform'
    def sync
      Database.migrate
      SyncManager.new.run(platform_name: options[:platform])
    end

    desc 'serve', 'Start the API server and optional AutoSync'
    method_option :port, aliases: '-p', type: :numeric, default: 4567, desc: 'API port'
    method_option :sync, type: :boolean, default: false, desc: 'Enable AutoSync in background'
    def serve
      Database.migrate

      sync_settings = Config.sync
      if options[:sync] || sync_settings[:auto]
        delay = sync_settings[:delay] || 10_800 # Default 3h
        logger.info "Starting AutoSync in background (delay: #{delay}s)..."

        Thread.new do
          loop do
            SyncManager.new.run
            logger.info "AutoSync completed. Sleeping for #{delay}s..."
            sleep delay
          rescue StandardError => e
            logger.error "AutoSync loop error: #{e.message}"
            sleep 60 # Retry after 1 minute on crash
          end
        end
      end

      logger.info "Starting API server on port #{options[:port]}..."
      ENV['API_PORT'] = options[:port].to_s
      Api.run!
    end

    desc 'reset', 'Reset the database'
    def reset
      if File.exist?('db/scopes_extractor.sqlite3')
        File.delete('db/scopes_extractor.sqlite3')
        logger.info 'Database reset successfully.'
      else
        logger.warn 'No database found to reset.'
      end
    end

    private

    def logger
      @logger ||= ScopesExtractor.logger
    end
  end
end

ScopesExtractor::CLI.start(ARGV)
